image: openjdk:18-jdk-slim
  # reactnativecommunity/react-native-android

variables:
  ADB_INSTALL_TIMEOUT: 20 # Timeout for ADB installation

before_script:
  # install updates and get necessary libraries
  - apt-get update && apt-get install -y curl sudo wget unzip bzip2 libdrm-dev libxkbcommon-dev libgbm-dev libasound-dev libnss3 libxcursor1 libpulse-dev libxshmfence-dev xauth xvfb git x11vnc fluxbox wmctrl libdbus-glib-1-2
  # Install Node.js and npm
  # Download and install nvm:
  - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
  # Download and install Node.js:
  - export NVM_DIR="$HOME/.nvm" 
  - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
  - '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"'
  - nvm install 23
  # Verify the Node.js version:
  - node -v # Should print "v23.6.1".
  - nvm current # Should print "v23.6.1".
  # Verify npm version:
  - npm -v # Should print "10.9.2".
  # Install pnpm globally
  - npm install -g pnpm
  # Install dependencies
  - pnpm install
  # Update sdkmanager
  - sdkmanager --update
  # libc6 libstdc++6 libgcc1 libx11-6 libx11-xcb1 libxrender1 libxrandr2 mesa-utils libpulse0 libxi6

stages:
  - android
  - build
  - test

android:
  stage: android
  tags:
    - android
  script:
    - echo "Setting up Android Emulator..."
    # Download and install the necessary Android SDK tools and emulator
    - sdkmanager --verbose "platform-tools" "platforms;android-30" "emulator" "system-images;android-30;google_apis;x86_64"
    - echo "yes" | sdkmanager --licenses
    # - sdkmanager --verbose "platform-tools" "platforms;android-30"

    # create the android virtual device and see that it was made correctly
    - echo "no" | avdmanager create avd -n test_avd -k "system-images;android-30;google_apis;x86_64" -d pixel
    # - if [ $? -ne 0 ]; then echo "Error- Failed to create AVD."; exit 1; fi
    - avdmanager list avd

    # Start the emulator in headless mode
    # - Xvfb :1 &
    # - export DISPLAY=:1
    - emulator -avd test_avd -no-snapshot -no-accel -no-audio -verbose > emulator.log 2>&1 &
    - tail -f emulator.log &

    # Wait for the emulator to boot
    # - adb start-server
    - abd devices
    - adb wait-for-device 
    # || (echo "Emulator failed to start"; exit 1)
    - adb shell input keyevent 82 # Unlock the emulator screen
    - echo "Emulator is ready!"
  artifacts:
    expire_in: 1 day
    when: always
    paths:
      - $ANDROID_HOME
      - emulator.log

build:
  stage: build
  tags: 
    - android
  script:
    - echo "Building..."
    - pnpm android
  artifacts:
    expire_in: 1 days
    when: on_success
    paths:
      - node_modules/

test:
  stage: test
  dependencies: 
    - android
    - build
  script: 
    - echo "Testing..."
    - pnpm test
  
  